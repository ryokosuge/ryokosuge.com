# Data Model: Claude Conversation Logs

## 概要

このドキュメントでは、`/save-conversation`スラッシュコマンドによって自動生成される会話ログコンテンツの データ構造を定義します。すべてのフィールドは自動生成され、手動編集は想定していません。

## エンティティ定義

### Conversation Log（会話ログ）

会話ログは、Claude Codeとの対話セッション全体を記録した単一のMarkdownファイルです。`/save-conversation`コマンド実行時に自動生成されます。

#### ファイル構造

```
content/conversations/[32文字ランダムID].md
```

**ファイル名規則**:
- 32文字の英数字ランダムID
- `/save-conversation`実行時に自動生成
- 生成コマンド: `openssl rand -base64 24 | tr -dc 'a-zA-Z0-9' | head -c 32`
- 例: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6.md`

#### フロントマター（メタデータ）

すべてのフィールドはAIが自動生成します：

```yaml
---
date: 2025-11-14T10:30:00+09:00  # コマンド実行時刻（自動）
draft: false                      # 常にfalse（自動公開）
title: "Hugoでブログを構築する方法" # AI自動生成（会話の主題）
description: "静的サイトジェネレータHugoを使ったブログ構築について議論。テーマ選択、コンテンツ管理、デプロイ方法を検討した。" # AI自動生成（2-3文の要約）
tags:                             # AI自動生成（3-5個のキーワード）
  - Hugo
  - 静的サイト
  - ブログ
  - Web開発
---
```

**フィールド詳細**:

| フィールド | 型 | 生成方法 | 説明 |
|-----------|---|---------|------|
| `date` | datetime | 自動（実行時刻） | `/save-conversation`実行時のタイムスタンプ |
| `draft` | boolean | 固定値（false） | 常に公開状態 |
| `title` | string | AI自動生成 | 会話の主題を1文で表現（30-60文字目安） |
| `description` | string | AI自動生成 | 会話の重要ポイントを要約（2-3文、100-200文字目安） |
| `tags` | array[string] | AI自動生成 | 会話から抽出されたキーワード（3-5個、優先度順） |

#### コンテンツ本文（会話ログ）

フロントマターの後、時系列フォーマットで会話が記録されます：

```markdown
---
(フロントマター)
---

## 会話ログ

### 2025-11-14 10:15:32

**User**: Hugoでブログを作りたいんですが、どこから始めればいいですか？

**Claude**: Hugoは高速な静的サイトジェネレータです。以下の手順で始められます：

1. Hugoをインストール
2. 新しいサイトを作成
3. テーマを選択
...

### 2025-11-14 10:17:45

**User**: テーマはどうやって選べばいいですか？

**Claude**: テーマ選択のポイントは...

（以下、会話が時系列で続く）
```

**フォーマット仕様**:

- **セクション分割**: 各メッセージペア（ユーザー→Claude）ごとに`###`見出し
- **タイムスタンプ**: `YYYY-MM-DD HH:MM:SS`形式
- **発言者表示**: `**User**:` と `**Claude**:` で区別
- **コードブロック**: 会話内のコードは適切にエスケープして保存
- **特殊文字**: Markdown記法として解釈されないようエスケープ

#### 自動生成アルゴリズム

`/save-conversation`実行時の処理フロー：

```
1. 会話履歴取得
   ├─ 現在セッションの全メッセージを取得
   ├─ ユーザーメッセージとClaudeレスポンスをペア化
   └─ タイムスタンプ情報を保持

2. AI分析
   ├─ タイトル生成
   │  └─ プロンプト: "この会話の主題を1文30-60文字で要約してください"
   ├─ 要約生成
   │  └─ プロンプト: "この会話の重要ポイントを2-3文100-200文字で要約してください"
   └─ タグ生成
      └─ プロンプト: "この会話から3-5個の重要キーワードを抽出してください"

3. ファイル生成
   ├─ ランダムID生成（32文字）
   ├─ フロントマター作成（AI生成結果を使用）
   ├─ 会話ログを時系列フォーマットに変換
   └─ content/conversations/[ID].mdに保存

4. 完了通知
   └─ ファイルパスとタイトルをユーザーに表示
```

#### バリデーションルール

自動生成時の検証：

1. **ファイル名**: 32文字の英数字（a-zA-Z0-9）のみ
2. **フロントマター**: 有効なYAML形式
3. **date**: ISO 8601形式のタイムスタンプ
4. **title**: 空でない文字列（1-100文字）
5. **description**: 空でない文字列（1-500文字）
6. **tags**: 配列、各要素は文字列（1-50文字）
7. **会話ログ**: 少なくとも1つのメッセージペアが存在

**エラー時のフォールバック**:

- タイトル生成失敗 → `"Conversation " + YYYY-MM-DD`
- 要約生成失敗 → `"会話の記録"`
- タグ生成失敗 → 空配列 `[]`

### Conversation Session（会話セッション）

`/save-conversation`実行時に取得される元データ。

#### 構造

- **メッセージリスト**: ユーザーとClaudeのメッセージの配列
- **タイムスタンプ**: 各メッセージの送信時刻
- **メタデータ**: セッションID、会話開始時刻など（利用可能な場合）

#### 取得方法

Claude Code内部のコンテキストから取得（実装時に調査）。

## データフロー

```
1. ユーザーがClaude Codeで会話
   ↓
2. 良い会話ができた！と判断
   ↓
3. /save-conversation を実行
   ↓
4. [自動] 会話セッション全体を取得
   ↓
5. [自動] AIが内容を分析（タイトル・要約・タグ生成）
   ↓
6. [自動] ランダムID生成
   ↓
7. [自動] Markdownファイル作成
   ↓
8. [自動] content/conversations/[ID].md に保存
   ↓
9. 完了メッセージ表示
   ↓
10. hugo server -D でローカルプレビュー
   ↓
11. Git commit & push
   ↓
12. 本番環境でhugo buildを実行
   ↓
13. 静的HTMLファイルが生成され、公開される
```

## 既存コンテンツタイプとの比較

| コンテンツタイプ | ディレクトリ | ファイル名規則 | 作成方法 | メタデータ入力 |
|----------------|------------|--------------|---------|--------------|
| Daily Logs | `content/daily-logs/` | `YYYYMMDD.md` | `/daily`コマンド | インタビュー形式 |
| Research Logs | `content/research-logs/` | ランダム32文字 | `/research`コマンド | インタビュー形式 |
| English Conversation | `content/english-conversation/` | ランダム32文字 | `/english`コマンド | 対話練習 |
| **Conversations** | `content/conversations/` | **ランダム32文字** | **`/save-conversation`** | **完全自動** |

すべてのコンテンツタイプは独立しており、相互参照はタグやリンクで行います。

## ストレージ仕様

- **形式**: Markdown (`.md`)
- **エンコーディング**: UTF-8
- **改行コード**: LF（Unix形式）
- **ファイルサイズ**: 制限なし（長い会話も1ファイルに保存）
- **バックアップ**: Gitリポジトリによるバージョン管理

## パフォーマンス考慮事項

- **生成時間**: `/save-conversation`実行から完了まで10秒以内を目標
- **AI分析**: タイトル・要約・タグ生成に数秒かかる可能性
- **ファイルI/O**: ローカルファイルシステムへの書き込み（即座）
- **Hugo ビルド**: 静的生成のため、ファイル数が増えてもビルド時間への影響は軽微

## 拡張性

将来的に以下の拡張が可能：

1. **カスタムプロンプト**
   - タイトル生成のスタイル指定
   - 要約の長さ調整
   - タグ数の変更

2. **選択的保存**
   - 会話の一部だけを保存
   - 特定のメッセージを除外

3. **事後編集機能**
   - 生成後に手動でメタデータ修正
   - 会話内容の追加編集

4. **テンプレートカスタマイズ**
   - 会話フォーマットのバリエーション
   - セクション構造のカスタマイズ

これらの拡張は、初期実装後にユーザーフィードバックを元に検討します。
